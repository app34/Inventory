<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>OBLU SELECT Sangeli Housekeeping List</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --primary-shadow: rgba(76, 175, 80, 0.4);
            --secondary-color: #333;
            --accent-color: #4CAF50; /* Changed to green */
            --accent-shadow: rgba(76, 175, 80, 0.3); /* Changed to green */
            --bg-primary: #0e0e10;
            --bg-secondary: #1a1a1d;
            --bg-tertiary: #333;
            --bg-hover: #444;
            --text-primary: #fff;
            --text-secondary: #ccc;
            --border-color: #444;
            --border-highlight: #4CAF50; /* Changed to green */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            padding: 10px;
            font-size: 16px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            font-size: 24px;
            padding: 10px 0;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 120px;
        }

        .title-presets {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .preset-button {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .preset-button:hover {
            background: var(--primary-color);
            color: var(--text-primary);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--primary-shadow);
        }

        .preset-button.active {
            background: linear-gradient(135deg, var(--primary-color), #3e8e41); /* Darker green */
            color: var(--text-primary);
            border-color: #3e8e41;
            box-shadow: 0 4px 15px var(--primary-shadow);
            transform: translateY(-2px);
        }

        .pantry-presets {
            margin-top: 10px;
            margin-bottom: 15px;
            gap: 8px;
        }

        .pantry-button {
            height: 52px;
            width: 120px;
            line-height: 1.4;
            padding: 6px 10px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 8px;
        }

        .input-section {
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="text"], input[type="number"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px; /* Prevents iOS zoom */
            background: var(--bg-tertiary);
            color: var(--text-primary);
            width: 100%;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        #pantryNumber, #personName {
            font-size: 14px;
        }

        input[type="number"] {
            width: 80px;
            background: #3a3a3a;
        }

        input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .item-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 10px;
        }

        .item {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            padding: 6px;
            border-left: 2px solid var(--primary-color);
            border-radius: 4px;
            align-items: center;
        }

        .item-name {
            flex: 1;
            font-size: 10px;
            color: var(--text-primary);
            word-break: break-word;
            line-height: 1.1;
            padding-right: 3px;
        }

        .item-name.highlight {
            color: #ffaaaa; /* Light Red */
        }

        .item-quantity {
            width: 40px;
            padding: 4px;
            text-align: center;
            font-weight: bold;
            color: var(--primary-color);
            background-color: var(--bg-tertiary);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 3px;
            font-size: 10px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 10px;
            padding: 10px;
        }

        button {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary-color), #3e8e41); /* Darker green */
            color: var(--text-primary);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--primary-shadow);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #3e8e41, #2e7d32); /* Darker green */
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--primary-shadow);
        }

        button:active:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px var(--primary-shadow);
        }

        button.admin {
            background-color: var(--primary-color);
        }

        button.admin:hover:not(:disabled) {
            background-color: #3e8e41;
        }

        .message {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 15px;
        }

        .success { background: #2ecc71; }
        .error { background: #e74c3c; }

        .floating-buttons {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: space-around;
            width: 50%;
            max-width: 220px;
            min-width: 160px;
            padding: 3px;
            background: rgba(26, 26, 29, 0.85);
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .floating-buttons.active {
            opacity: 1;
        }

        .floating-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--text-primary);
            border: none;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s, transform 0.2s;
            margin: 0 3px;
            padding: 0;
            line-height: 1;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .password-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }

        .modal-content input {
            margin: 10px 0;
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-content .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .modal-content button {
            flex: 1;
            padding: 10px;
        }

        .admin-menu {
            display: block;
            visibility: hidden;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-bottom: none;
            padding: 15px;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 20px var(--primary-shadow);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out, visibility 0.3s;
        }

        .admin-menu h2 {
            font-size: 16px;
            margin-bottom: 12px;
            text-align: center;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-shadow);
        }

        .admin-button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .admin-menu button {
            margin: 0;
            width: 100%;
            padding: 12px;
            font-size: 14px;
        }

        .admin-menu input, .admin-menu textarea, .admin-menu select {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 10px auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            display: block;
        }

        .admin-menu textarea {
            height: 100px;
            resize: vertical;
        }

        @media (max-width: 500px) {
            .item-grid {
                grid-template-columns: 1fr 1fr;
            }
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            .floating-buttons {
                width: 80%;
                min-width: 180px;
            }
            .floating-button {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }
            .pantry-button {
                width: calc(50% - 4px);
            }
            .modal-content {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OBLU SELECT SANGELI HOUSEKEEPING LIST</h1>

        <div class="title-presets">
            <button class="preset-button" onclick="setTitle('Trolley & Tricycle Inventory', this)">Trolley & Tricycle</button>
            <button class="preset-button" onclick="setTitle('Pantry Request', this)">Pantry Request</button>
            <button class="preset-button" onclick="setTitle('Pantry Inventory', this)">Pantry Inventory</button>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="pdfTitle" placeholder="List Title">
            </div>

            <div class="input-group">
                <input type="text" id="personName" placeholder="Filled by (Name)">
            </div>

            <div class="input-group">
                <input type="text" id="pantryNumber" placeholder="Pantry Number">
            </div>

            <div class="title-presets pantry-presets">
                <button class="preset-button pantry-button" onclick="setPantryNumber('Water Villa - 1st Pantry', this)">Water Villa<br>1st Pantry</button>
                <button class="preset-button pantry-button" onclick="setPantryNumber('Water Villa - 2nd Pantry', this)">Water Villa<br>2nd Pantry</button>
                <button class="preset-button pantry-button" onclick="setPantryNumber('Beach Villa - 1st Pantry', this)">Beach Villa<br>1st Pantry</button>
                <button class="preset-button pantry-button" onclick="setPantryNumber('Beach Villa - 2nd Pantry', this)">Beach Villa<br>2nd Pantry</button>
            </div>
        </div>

        <div class="item-grid" id="itemList"></div>

        <div class="action-buttons">
            <button onclick="copyList()">Copy</button>
            <button onclick="importList()">Import</button>
            <button onclick="resetList()">Reset</button>
            <button onclick="exportPDF()">PDF</button>
            <button onclick="exportXLSX()">XLSX</button>
            <button onclick="showHistoryForAll()">History</button>
            <button onclick="toggleAdmin()" id="adminBtn" class="admin">Admin</button>
        </div>

        <div class="message" id="message"></div>
    </div>

    <div class="floating-buttons" id="floatingButtons">
        <button class="floating-button" title="Export PDF" onclick="exportPDF()">ðŸ“„</button>
        <button class="floating-button" title="Export XLSX" onclick="exportXLSX()">ðŸ“Š</button>
        <button class="floating-button" title="Copy List" onclick="copyList()">ðŸ“‹</button>
    </div>

    <div class="password-modal" id="passwordModal">
        <div class="modal-content">
            <h2>Admin Login</h2>
            <input type="password" id="adminPassword" placeholder="Enter Password">
            <div class="modal-buttons">
                <button onclick="verifyAdmin()">Login</button>
                <button onclick="closePasswordModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="admin-menu" id="adminMenu">
        </div>

    <script id="appData">
        let appData = {
            trolleyItems: [
                { name: "Shampoo 300Ml", displayName: "Shampoo 300Ml", fullName: "Shampoo 300Ml Company Noir", quantity: 0 }, 
                { name: "Conditioner 300Ml", displayName: "Conditioner 300Ml", fullName: "Conditioner 300Ml Company Noir", quantity: 0 }, 
                { name: "Shower Gel 300Ml", displayName: "Shower Gel 300Ml", fullName: "Shower Gel 300Ml Company Noir", quantity: 0 }, 
                { name: "Hand & Body Lotion 300Ml", displayName: "Hand & Body Lotion 300Ml", fullName: "Hand & Body Lotion 300Ml Company Noir", quantity: 0 }, 
                { name: "Cleansing Hand Wash 300Ml", displayName: "Cleansing Hand Wash 300Ml", fullName: "Cleansing Hand Wash 300Ml Company Noir", quantity: 0 }, 
                { name: "Soap Wrapped 306", displayName: "Soap Wrapped 306", fullName: "Soap Wrapped 306 Company Noir", quantity: 0 }, 
                { name: "Vanity Pack - A", displayName: "Vanity Pack - A", fullName: "Kimirica White Gold Vanity Pack - A", quantity: 0 }, 
                { name: "Premium Shower Cap", displayName: "Premium Shower Cap", fullName: "Kimirica White Gold Premium Shower Cap", quantity: 0 }, 
                { name: "Sanitary Bag", displayName: "Sanitary Bag", fullName: "Kimirica White Gold Sanitary Bag", quantity: 0 }, 
                { name: "Standard Toothbrush Pack", displayName: "Standard Toothbrush Pack", fullName: "Kimirica White Gold Standard Toothbrush Pack", quantity: 0 }, 
                { name: "Razor Pack", displayName: "Razor Pack", fullName: "Kimirica Razor Pack", quantity: 0 }, 
                { name: "Comb Kit", displayName: "Comb Kit", fullName: "Comb Kit", quantity: 0 }, 
                { name: "Stich Kit", displayName: "Stich Kit", fullName: "Stich Kit", quantity: 0 }, 
                { name: "Natural Loofah Kit", displayName: "Natural Loofah Kit", fullName: "Natural Loofah Kit", quantity: 0 }, 
                { name: "LipBam", displayName: "LipBam", fullName: "LipBam", quantity: 0 }, 
                { name: "Sunscreen Lotion", displayName: "Sunscreen Lotion", fullName: "Sunscreen Lotion", quantity: 0 }, 
                { name: "Insect Repellent Lotion", displayName: "Insect Repellent Lotion", fullName: "Insect Repellent Lotion", quantity: 0 }, 
                { name: "Facial Tissue Cube Box", displayName: "Facial Tissue Cube Box", fullName: "Scott Facial Tissue Cube Box 90 Sheets", quantity: 0 }, 
                { name: "Toilet Roll", displayName: "Toilet Roll", fullName: "Smartchoice Toilet Roll 2 Ply - 1x80 Rolls", quantity: 0 }, 
                { name: "Milk Portion Rainbow 14g", displayName: "Milk Portion Rainbow 14g", fullName: "Milk Portion Rainbow 14g", quantity: 0 }, 
                { name: "Espresso Cremoso 50 Cap", displayName: "Espresso Cremoso 50 Cap", fullName: "Coffee Espresso Cremoso 50 Cap", quantity: 0 }, 
                { name: "Espresso Decaffeinato 50 Cap", displayName: "Espresso Decaffeinato 50 Cap", fullName: "Coffee Espresso Decaffeinato 50 Cap", quantity: 0 }, 
                { name: "Espresso Intenso 50 Cap", displayName: "Espresso Intenso 50 Cap", fullName: "Coffee Espresso Intenso 50 Cap", quantity: 0 }, 
                { name: "Segafredo Le Origini Brasil Capsules", displayName: "Segafredo Le Origini Brasil Capsules", fullName: "Coffee Segafredo Le Origini Brasil Capsules 6gmx50", quantity: 0, highlight: true }, 
                { name: "Segafredo Espresso Capsules", displayName: "Segafredo Espresso Capsules", fullName: "Coffee Segafredo Espresso Capsules 6gmx50", quantity: 0, highlight: true }, 
                { name: "Segafredo Decaffeinated Capsules", displayName: "Segafredo Decaffeinated Capsules", fullName: "Coffee Segafredo Decaffeinated Capsules 6gmx50", quantity: 0, highlight: true }, 
                { name: "Sugar Brown", displayName: "Sugar Brown", fullName: "Sugar Brown Sachets - 5G", quantity: 0 }, 
                { name: "Sugar White", displayName: "Sugar White", fullName: "Sugar White Sachets - 5G", quantity: 0 }, 
                { name: "Equival Sugar", displayName: "Equival Sugar", fullName: "Sugar Equival Sugar 10g", quantity: 0 }, 
                { name: "English Breakfast Tea", displayName: "English Breakfast Tea", fullName: "Ravena English Breakfast Tea 2g (1*250)", quantity: 0 }, 
                { name: "Peppermint Tea", displayName: "Peppermint Tea", fullName: "Ravena Peppermint (Black Tea) 1.8g (1*250)", quantity: 0 }, 
                { name: "Green Tea", displayName: "Green Tea", fullName: "Ravena Pur Green Tea 2g (1*250)", quantity: 0 }, 
                { name: "Chamomile Tea", displayName: "Chamomile Tea", fullName: "Ravena Chamomile (Herbal Tea)", quantity: 0 }, 
                { name: "Earl Grey Tea", displayName: "Earl Grey Tea", fullName: "Ravena Earl Grey", quantity: 0 }, 
                { name: "Garbage Bag SMALL", displayName: "Garbage Bag SMALL", fullName: "Garbage Bag Green Colour 19cm x 22cm - SMALL", quantity: 0 }
            ],
            pantryItems: [
                { name: "Shampoo Noir (3ltr, Gellon)", quantity: 0 }, { name: "Conditioner Noir(3ltr, Gellon)", quantity: 0 }, { name: "Shower Gel Noir (3ltr, Gellon)", quantity: 0 }, { name: "Hand & Body Lotion Noir (3ltr, Gellon)", quantity: 0 }, { name: "Cleansing Hand Noir (3ltr, Gellon)", quantity: 0 }, { name: "Soap Wrapped 30G Noir", quantity: 0 }, { name: "Shampoo Noir (300ml)", quantity: 0 }, { name: "Conditioner Noir(300ml)", quantity: 0 }, { name: "Shower Gel Noir(300ml)", quantity: 0 }, { name: "Hand & Body Lotion Noir(300ml)", quantity: 0 }, { name: "Cleansing Hand Noir (300ml)", quantity: 0 }, { name: "Kimnica White Gold Standard Toothbrush Pack", quantity: 0 }, { name: "Kimnica Razor Pack(on request)", quantity: 0 }, { name: "Stich kit(on request)", quantity: 0 }, { name: "Wooden Comb kit(on request)", quantity: 0 }, { name: "Natural Lordah kit(on request)", quantity: 0 }, { name: "Sunscreen lotion(on request)", quantity: 0 }, { name: "Insect repellent lotion(on request)", quantity: 0 }, { name: "Lip Balm", quantity: 0 }, { name: "Bathroom Slippers Kit Size 10", quantity: 0 }, { name: "Bathroom Slippers Kit Size 11", quantity: 0 }, { name: "Scott Facial Tissue Cube Box 90 Sheets(48)", quantity: 0 }, { name: "Kleenex bathroom Tissue 2ply - 50Opulls x 20rolls x 4bags", quantity: 0 }, { name: "Milk Portion Rainbow 14g", quantity: 0 }, { name: "Coffee Espresso Cremoso 50 Cap - Vergnano", quantity: 0 }, { name: "Coffee Espresso Decaffeinated 50 Cap - Vergnano", quantity: 0 }, { name: "Coffee Espresso Intenso 50 Cap - Vergnano", quantity: 0 }, { name: "Coffee Segafredo Le Origini Brasil Capsules 6gmx50", quantity: 0 }, { name: "Coffee Segafredo Espresso Capsules 6gmx150", quantity: 0 }, { name: "Coffee Segafredo Decaffeinated Capsules 6gmx50", quantity: 0 }, { name: "Sugar Brown Sachets - 5G", quantity: 0 }, { name: "Sugar White Sachets - 5G", quantity: 0 }, { name: "Sugar Equal Sugar 10g", quantity: 0 }, { name: "Ravena Tea English Breakfast Bag", quantity: 0 }, { name: "Ravena Tea Green tea", quantity: 0 }, { name: "Ravena Charnomile (Herbal Tea)", quantity: 0 }, { name: "Ravena Tea permit", quantity: 0 }, { name: "Mosquito Spray - 640ml / 400ml(only beach villas)", quantity: 0 }, { name: "outdoor slipper - 10\" - Orange colour", quantity: 0 }, { name: "outdoor slipper - 11\" - Blue colour", quantity: 0 }, { name: "Canvas Beach Bag 57 X 12X 40cm", quantity: 0 }, { name: "Laundry Bag with the Logo/without Logo", quantity: 0 }, { name: "Brasso", quantity: 0 }, { name: "R1", quantity: 0 }, { name: "R2", quantity: 0 }, { name: "R3", quantity: 0 }, { name: "R4", quantity: 0 }, { name: "R5", quantity: 0 }, { name: "R6", quantity: 0 }, { name: "R7", quantity: 0 }, { name: "Dustin Bag", quantity: 0 }, { name: "Bubble Bath", quantity: 0 }
            ],
            exportStyles: { pdf: "default", xlsx: "default" }
        };
    </script>

    <script>
        const ADMIN_PASSWORD = "000000";
        let isAdmin = false;
        let items = appData.trolleyItems;

        // --- PRESET AND STATE MANAGEMENT FUNCTIONS ---
        function setTitle(newTitle, clickedButton) {
            document.getElementById('pdfTitle').value = newTitle;

            const presetButtons = document.querySelectorAll('.preset-button:not(.pantry-button)');
            presetButtons.forEach(b => b.classList.remove('active'));

            const buttonToActivate = clickedButton || [...presetButtons].find(b => b.textContent === newTitle);
            if (buttonToActivate) buttonToActivate.classList.add('active');

            // Show/hide pantry section based on title - person name always visible
            const pantryInput = document.querySelector('.input-group:has(#pantryNumber)');
            const pantryPresets = document.querySelector('.title-presets.pantry-presets');

            if (newTitle === 'Trolley & Tricycle Inventory') {
                // Hide only pantry-related elements
                pantryInput.style.display = 'none';
                pantryPresets.style.display = 'none';
                items = appData.trolleyItems;
            } else if (newTitle === 'Pantry Request' || newTitle === 'Pantry Inventory') {
                // Show pantry elements
                pantryInput.style.display = 'flex';
                pantryPresets.style.display = 'flex';
                items = appData.pantryItems;
            } else {
                // Hide pantry elements for other titles
                pantryInput.style.display = 'none';
                pantryPresets.style.display = 'none';
                items = appData.trolleyItems;
            }
            renderItems();
            updateFloatingButtons();
        }

        function setPantryNumber(pantryName, clickedButton) {
            document.getElementById('pantryNumber').value = pantryName;
            updatePantryButtonState(pantryName);
            if (clickedButton) clickedButton.classList.add('active');
        }

        function updatePantryButtonState(pantryName) {
            const pantryButtons = document.querySelectorAll('.pantry-button');
            pantryButtons.forEach(b => {
                const buttonText = b.textContent.replace(/<br\s*\/?>|\n/g, " ").replace(/\s+/g, ' ').trim();
                if (buttonText === pantryName.trim()) {
                    b.classList.add('active');
                } else {
                    b.classList.remove('active');
                }
            });
        }

        window.onload = function() {
            setTitle('Trolley & Tricycle Inventory', document.querySelector('.preset-button'));
            updateFloatingButtons();
            showAdminMenu(); // Pre-populate admin menu so it's ready
            document.getElementById('adminMenu').classList.remove('active');
        };

        function renderItems() {
            const container = document.getElementById('itemList');
            container.innerHTML = '';
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                const displayName = item.displayName || item.name;
                const highlightClass = item.highlight ? ' highlight' : '';
                itemDiv.innerHTML = `
                    <div class="item-name${highlightClass}">${displayName}</div>
                    <input type="number" class="item-quantity" value="${item.quantity}" 
                           min="0" data-index="${index}" inputmode="numeric" pattern="[0-9]*">
                    ${isAdmin ? `<button class="floating-button" style="width: 30px; height: 30px; font-size: 16px;" onclick="removeItem(${index})" title="Remove Item">Ã—</button>` : ''}`;
                container.appendChild(itemDiv);
            });
            document.querySelectorAll('.item-quantity').forEach(input => {
                // iOS-compatible input handling
                input.addEventListener('change', function() { 
                    updateQuantity(this.dataset.index, this.value);
                    updateFloatingButtons();
                });
                
                // Debounced input for iOS
                let inputTimeout;
                input.addEventListener('input', function() {
                    clearTimeout(inputTimeout);
                    inputTimeout = setTimeout(() => {
                        updateQuantity(this.dataset.index, this.value);
                        updateFloatingButtons();
                    }, 100);
                });
                
                input.addEventListener('focus', function() { 
                    if (this.value === '0') this.value = ''; 
                    // Remove readonly for iOS keyboard
                    this.removeAttribute('readonly');
                });
                
                input.addEventListener('blur', function() { 
                    if (this.value === '') { 
                        this.value = '0'; 
                        updateQuantity(this.dataset.index, 0); 
                    }
                    updateFloatingButtons();
                });
                
                // Prevent iOS double-tap zoom on inputs
                input.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.focus();
                }, { passive: false });
            });
        }

        function updateQuantity(index, value) {
            items[index].quantity = parseInt(value) || 0;
            updateFloatingButtons();
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            setTimeout(() => msg.textContent = '', 3000);
        }

        function resetList() {
            if (confirm('Reset all quantities for the current list to zero?')) {
                items.forEach(item => item.quantity = 0);
                renderItems();
                updateFloatingButtons();
                showMessage('All quantities reset!', 'success');
            }
        }

        // --- COPY AND IMPORT FUNCTIONS ---
        function copyList() {
            if (!validateRequiredFields('copy operation')) {
                return;
            }

            const title = document.getElementById('pdfTitle').value.trim() || 'Housekeeping List';
            const personName = document.getElementById('personName').value.trim();
            const pantryNum = document.getElementById('pantryNumber').value.trim();
            const hasItems = items.some(item => item.quantity > 0);

            if (!hasItems) {
                showMessage('No items with quantities to copy. Please add some quantities first.', 'error');
                return;
            }

            let textToCopy = `Title: ${title}\n`;
            textToCopy += `Person Name: ${personName}\n`;
            textToCopy += `Pantry Number: ${pantryNum}\n`;
            textToCopy += `Date: ${new Date().toLocaleString('en-US', { timeZone: 'Indian/Maldives' })}\n`;
            textToCopy += '---\n';

            // Only include items with quantities > 0 for cleaner copy
            const itemsWithQuantity = items.filter(item => item.quantity > 0);
            itemsWithQuantity.forEach(item => {
                const exportName = item.fullName || item.name;
                textToCopy += `${exportName}: ${item.quantity}\n`;
            });

            // Add summary
            textToCopy += `\n--- Summary ---\n`;
            textToCopy += `Total Items: ${itemsWithQuantity.length}\n`;
            textToCopy += `Total Quantity: ${itemsWithQuantity.reduce((sum, item) => sum + item.quantity, 0)}\n`;

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Save to history
                    saveToHistory('Copy List', {
                        title: title,
                        personName: personName,
                        pantryNumber: pantryNum,
                        items: itemsWithQuantity.map(item => ({
                            name: item.fullName || item.name,
                            quantity: item.quantity
                        }))
                    });
                    showMessage(`Copied ${itemsWithQuantity.length} items with quantities successfully!`, 'success');
                }).catch(() => fallbackCopyTextToClipboard(textToCopy));
            } else {
                fallbackCopyTextToClipboard(textToCopy);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            // iOS-optimized clipboard fallback
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // iOS-specific styling
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "100%";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            textArea.style.color = "transparent";
            textArea.style.fontSize = "16px"; // Prevents iOS zoom
            textArea.readOnly = false;
            textArea.contentEditable = true;
            textArea.style.opacity = "0";
            textArea.style.pointerEvents = "none";
            
            document.body.appendChild(textArea);
            
            // iOS detection
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            let successful = false;
            
            try {
                if (isIOS) {
                    // iOS-specific selection
                    textArea.contentEditable = true;
                    textArea.readOnly = false;
                    
                    const range = document.createRange();
                    range.selectNodeContents(textArea);
                    
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    textArea.setSelectionRange(0, text.length);
                    
                    // Try to copy
                    successful = document.execCommand('copy');
                } else {
                    textArea.focus();
                    textArea.select();
                    successful = document.execCommand('copy');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                successful = false;
            }
            
            // Clean up
            document.body.removeChild(textArea);
            
            if (successful) {
                const title = document.getElementById('pdfTitle').value.trim() || 'Housekeeping List';
                const personName = document.getElementById('personName').value.trim();
                const pantryNum = document.getElementById('pantryNumber').value.trim();
                const itemsWithQuantity = items.filter(item => item.quantity > 0);

                if (personName) {
                    saveToHistory('Copy List', {
                        title: title,
                        personName: personName,
                        pantryNumber: pantryNum,
                        items: itemsWithQuantity.map(item => ({
                            name: item.fullName || item.name,
                            quantity: item.quantity
                        }))
                    });
                }

                showMessage('âœ“ List copied successfully!', 'success');
            } else {
                // Show modal for manual copy on iOS
                showCopyModal(text);
            }
        }

        function showCopyModal(text) {
            const modal = document.createElement('div');
            modal.className = 'password-modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 90%; max-width: 500px;">
                    <h2>Copy List</h2>
                    <p style="font-size: 12px; color: #ccc; margin-bottom: 10px;">Tap and hold the text below, then select "Copy All":</p>
                    <textarea readonly style="width: 100%; height: 300px; padding: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; font-family: monospace; -webkit-user-select: all; user-select: all;">${text}</textarea>
                    <div class="modal-buttons" style="margin-top: 15px;">
                        <button onclick="this.closest('.password-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // iOS-optimized text selection
            setTimeout(() => {
                const textarea = modal.querySelector('textarea');
                if (textarea) {
                    textarea.focus();
                    textarea.setSelectionRange(0, text.length);
                    
                    // Try to select all on iOS
                    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                        const range = document.createRange();
                        range.selectNodeContents(textarea);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        textarea.select();
                    }
                }
            }, 300);
        }

        function importList() {
            // iOS-compatible import modal
            const modal = document.createElement('div');
            modal.className = 'password-modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 90%; max-width: 500px;">
                    <h2>Import List</h2>
                    <p style="font-size: 12px; color: #ccc; margin-bottom: 10px;">Paste your copied list below:</p>
                    <textarea id="importTextArea" placeholder="Paste your list here..." style="width: 100%; height: 200px; padding: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; font-family: monospace; resize: vertical; -webkit-appearance: none;"></textarea>
                    <div class="modal-buttons" style="margin-top: 15px;">
                        <button onclick="processImport()">Import</button>
                        <button onclick="closeImportModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // iOS-friendly focus with delay
            setTimeout(() => {
                const textarea = document.getElementById('importTextArea');
                if (textarea) {
                    textarea.focus();
                    // Trigger click to ensure keyboard appears on iOS
                    textarea.click();
                }
            }, 300);
        }

        function closeImportModal() {
            const modal = document.querySelector('.password-modal.active');
            if (modal && modal.querySelector('#importTextArea')) {
                modal.remove();
            }
        }

        function processImport() {
            const pastedText = document.getElementById('importTextArea').value;
            
            if (!pastedText || pastedText.trim() === '') {
                showMessage('Please paste some content to import.', 'error');
                return;
            }

            const lines = pastedText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let headerParsed = false;
            const quantityMap = new Map();
            let importedCount = 0;
            let newItemsAdded = 0;
            let titleChanged = false;
            let hasValidData = false;

            for (const line of lines) {
                if (line === '---') {
                    headerParsed = true;
                    continue;
                }

                if (!headerParsed) {
                    if (line.startsWith('Title:')) {
                        const newTitle = line.substring(6).trim();
                        const currentTitle = document.getElementById('pdfTitle').value.trim();
                        if (newTitle && newTitle !== currentTitle) {
                            setTitle(newTitle);
                            titleChanged = true;
                        }
                    } else if (line.startsWith('Person Name:')) {
                        const personName = line.substring(12).trim();
                        if (personName && personName !== 'N/A') {
                            document.getElementById('personName').value = personName;
                        }
                    } else if (line.startsWith('Pantry Number:')) {
                        const newPantry = line.substring(14).trim();
                        if (newPantry && newPantry !== 'N/A') {
                            document.getElementById('pantryNumber').value = newPantry;
                            updatePantryButtonState(newPantry);
                        }
                    }
                } else {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) continue;

                    const name = line.substring(0, colonIndex).trim();
                    const quantityStr = line.substring(colonIndex + 1).trim();
                    const quantity = parseInt(quantityStr, 10);

                    if (name && !isNaN(quantity) && quantity >= 0) {
                        quantityMap.set(name, quantity);
                        hasValidData = true;
                    }
                }
            }

            if (!hasValidData) {
                showMessage('No valid item data found in import text.', 'error');
                return;
            }

            // First, try to match existing items by full name, display name, or name
            items.forEach(item => {
                const itemNames = [
                    item.fullName,
                    item.displayName,
                    item.name
                ].filter(Boolean);

                for (const itemName of itemNames) {
                    if (quantityMap.has(itemName)) {
                        item.quantity = quantityMap.get(itemName);
                        quantityMap.delete(itemName); // Remove from map so we don't add it as new item
                        importedCount++;
                        break;
                    }
                }
            });

            // Add any remaining items as new items (if admin is logged in)
            if (isAdmin && quantityMap.size > 0) {
                quantityMap.forEach((quantity, name) => {
                    if (quantity > 0) { // Only add items with non-zero quantities
                        items.push({ 
                            name: name, 
                            displayName: name,
                            quantity: quantity 
                        });
                        newItemsAdded++;
                    }
                });
            }

            renderItems();
            updateFloatingButtons();
            closeImportModal();

            let successMessage = `Successfully imported ${importedCount} quantities`;
            if (titleChanged) successMessage += `, switched to correct menu`;
            if (newItemsAdded > 0) successMessage += `, added ${newItemsAdded} new items`;
            if (!isAdmin && quantityMap.size > 0) {
                successMessage += `. Note: ${quantityMap.size} unmatched items ignored (admin access required to add new items)`;
            }
            successMessage += '.';

            showMessage(successMessage, 'success');
        }

        // --- FLOATING BUTTONS ---
        function updateFloatingButtons() {
            const floatingButtons = document.getElementById('floatingButtons');
            const hasNonZero = items.some(item => item.quantity > 0);
            floatingButtons.classList.toggle('active', hasNonZero);
        }

        // This function is no longer used by the floating buttons but is kept for potential future use.
        function adjustAllQuantities(delta) {
            items.forEach(item => {
                item.quantity = Math.max(0, item.quantity + delta);
            });
            renderItems();
            updateFloatingButtons();
        }

        // --- SYNC FUNCTIONS ---
        function syncTrolleyItemsToPantry() {
            let addedCount = 0;
            const addedItems = [];

            appData.trolleyItems.forEach(trolleyItem => {
                // Check if this item already exists in pantry items
                const existsInPantry = appData.pantryItems.some(pantryItem => 
                    pantryItem.name === trolleyItem.name || 
                    pantryItem.name === trolleyItem.displayName ||
                    pantryItem.name === trolleyItem.fullName
                );

                if (!existsInPantry) {
                    // Add the item to pantry with quantity 0
                    appData.pantryItems.push({
                        name: trolleyItem.name,
                        displayName: trolleyItem.displayName,
                        fullName: trolleyItem.fullName,
                        quantity: 0,
                        highlight: trolleyItem.highlight
                    });
                    addedCount++;
                    addedItems.push(trolleyItem.name);
                }
            });

            if (addedCount > 0) {
                // If currently viewing pantry, refresh the display
                const currentTitle = document.getElementById('pdfTitle').value.trim();
                if (currentTitle.includes('Pantry')) {
                    items = appData.pantryItems;
                    renderItems();
                }

                showMessage(`Synced ${addedCount} new items from Trolley to Pantry inventory`, 'success');
                console.log('Added items:', addedItems);
            } else {
                showMessage('No new items to sync - pantry inventory is up to date', 'success');
            }
        }

        // --- ADMIN FUNCTIONS ---
        function toggleAdmin() {
            if (isAdmin) {
                const adminMenu = document.getElementById('adminMenu');
                if (adminMenu.classList.contains('active')) {
                    adminMenu.classList.remove('active');
                } else {
                    showAdminMenu();
                    adminMenu.classList.add('active');
                }
            } else {
                document.getElementById('passwordModal').classList.add('active');
                document.getElementById('adminPassword').focus();
            }
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('adminPassword').value = '';
        }

        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('adminBtn').textContent = 'Admin Tools';
                document.getElementById('adminBtn').style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                closePasswordModal();
                document.getElementById('adminMenu').classList.add('active');
                renderItems();
                showMessage('Admin access granted!', 'success');
            } else {
                showMessage('Incorrect password!', 'error');
                document.getElementById('adminPassword').value = '';
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            document.getElementById('adminBtn').textContent = 'Admin';
            document.getElementById('adminBtn').style.background = 'linear-gradient(135deg, #ff4bd8, #e03ab7)';
            document.getElementById('adminMenu').classList.remove('active');
            renderItems();
            showMessage('Logged out of admin mode.', 'success');
        }

        function showAddItemForm() {
            document.getElementById('adminMenu').innerHTML = `
                <h2>Add New Item</h2>
                <input type="text" id="newItemName" placeholder="Enter item name">
                <div class="admin-button-grid">
                    <button onclick="addItem()">Add Item</button>
                    <button onclick="showAdminMenu()">Cancel</button>
                </div>
            `;
        }

        function addItem() {
            const itemName = document.getElementById('newItemName').value.trim();
            if (!itemName) {
                showMessage('Item name cannot be empty!', 'error');
                return;
            }
            if (items.some(item => item.name.toLowerCase() === itemName.toLowerCase())) {
                showMessage('Item already exists!', 'error');
                return;
            }
            items.push({ name: itemName, quantity: 0 });
            renderItems();
            showAdminMenu();
            showMessage(`Item "${itemName}" added!`, 'success');
        }

        function showRemoveItemForm() {
            let selectOptions = '<option value="">Select item to remove...</option>';
            items.forEach((item, index) => {
                selectOptions += `<option value="${index}">${item.name}</option>`;
            });
            document.getElementById('adminMenu').innerHTML = `
                <h2>Remove Existing Item</h2>
                <select id="removeItemSelect">${selectOptions}</select>
                <div class="admin-button-grid">
                    <button onclick="removeItem()">Remove Selected</button>
                    <button onclick="showAdminMenu()">Cancel</button>
                </div>
            `;
        }

        function removeItem(index) {
            if (index === undefined) {
                const select = document.getElementById('removeItemSelect');
                index = select ? select.value : null;
            }
            if (index !== null && index !== "" && confirm(`Remove "${items[index].name}" from the list?`)) {
                items.splice(index, 1);
                renderItems();
                // If the remove was triggered from the menu, refresh the menu view
                if (document.getElementById('removeItemSelect')) {
                    showAdminMenu();
                }
                showMessage('Item removed!', 'success');
            }
        }

        function showBulkAddForm() {
            document.getElementById('adminMenu').innerHTML = `
                <h2>Bulk Add Items</h2>
                <textarea id="bulkItems" placeholder="Enter item names, one per line"></textarea>
                <div class="admin-button-grid">
                    <button onclick="bulkAddItems()">Add All</button>
                    <button onclick="showAdminMenu()">Cancel</button>
                </div>
            `;
        }

        function bulkAddItems() {
            const itemText = document.getElementById('bulkItems').value.trim();
            if (!itemText) {
                showMessage('No items entered!', 'error');
                return;
            }
            const itemNames = itemText.split('\n').map(name => name.trim()).filter(name => name);
            let addedCount = 0;
            itemNames.forEach(name => {
                if (!items.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                    items.push({ name, quantity: 0 });
                    addedCount++;
                }
            });
            renderItems();
            showAdminMenu();
            showMessage(`Added ${addedCount} new items!`, 'success');
        }

        function showAdminMenu() {
            // Hide history section if visible
            const historySection = document.getElementById('historySection');
            if (historySection) {
                historySection.style.display = 'none';
            }

            document.getElementById('adminMenu').innerHTML = `
                <h2>Admin Panel</h2>
                <div class="admin-button-grid">
                    <button onclick="showAddItemForm()">Add Item</button>
                    <button onclick="showRemoveItemForm()">Remove Item</button>
                    <button onclick="showBulkAddForm()">Bulk Add</button>
                    <button onclick="syncTrolleyItemsToPantry()">Sync Trolleyâ†’Pantry</button>
                    <button onclick="showHistoryList()">ðŸ“‹ View History</button>
                    <button onclick="logoutAdmin()">Logout & Close</button>
                </div>
            `;
        }

        // --- ENHANCED HISTORY MANAGEMENT ---
        const HISTORY_STORAGE_KEY = 'oblu_housekeeping_history';
        let historyFilters = {
            action: 'all',
            dateRange: 'all',
            person: 'all',
            searchTerm: ''
        };

        function saveToHistory(action, data) {
            try {
                const history = getHistoryFromStorage();
                const timestamp = new Date().toISOString();
                const historyEntry = {
                    id: timestamp + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: timestamp,
                    action: action,
                    data: {
                        ...data,
                        // Enhanced data tracking
                        totalItems: data.items ? data.items.length : 0,
                        totalQuantity: data.items ? data.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0,
                        browser: navigator.userAgent.split(' ').pop(),
                        sessionId: getOrCreateSessionId()
                    },
                    humanDate: new Date().toLocaleString('en-US', { 
                        timeZone: 'Indian/Maldives',
                        year: 'numeric',
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }),
                    dayOfWeek: new Date().toLocaleDateString('en-US', { weekday: 'long', timeZone: 'Indian/Maldives' }),
                    dateOnly: new Date().toLocaleDateString('en-US', { timeZone: 'Indian/Maldives' })
                };

                history.unshift(historyEntry);

                // Keep only last 200 entries (increased from 100)
                if (history.length > 200) {
                    history.splice(200);
                }

                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
                return historyEntry.id;
            } catch (error) {
                console.error('Error saving to history:', error);
                showMessage('Warning: Could not save to history', 'error');
            }
        }

        function getOrCreateSessionId() {
            let sessionId = sessionStorage.getItem('oblu_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('oblu_session_id', sessionId);
            }
            return sessionId;
        }

        function getHistoryFromStorage() {
            try {
                const historyData = localStorage.getItem(HISTORY_STORAGE_KEY);
                return historyData ? JSON.parse(historyData) : [];
            } catch (error) {
                console.error('Error loading history:', error);
                return [];
            }
        }

        function getFilteredHistory() {
            let history = getHistoryFromStorage();

            // Filter by action
            if (historyFilters.action !== 'all') {
                history = history.filter(entry => entry.action.toLowerCase().includes(historyFilters.action.toLowerCase()));
            }

            // Filter by date range
            if (historyFilters.dateRange !== 'all') {
                const now = new Date();
                let cutoffDate;
                switch (historyFilters.dateRange) {
                    case 'today':
                        cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        cutoffDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        break;
                }
                if (cutoffDate) {
                    history = history.filter(entry => new Date(entry.timestamp) >= cutoffDate);
                }
            }

            // Filter by person
            if (historyFilters.person !== 'all') {
                history = history.filter(entry => 
                    entry.data.personName && entry.data.personName.toLowerCase().includes(historyFilters.person.toLowerCase())
                );
            }

            // Filter by search term
            if (historyFilters.searchTerm) {
                const searchTerm = historyFilters.searchTerm.toLowerCase();
                history = history.filter(entry => 
                    entry.action.toLowerCase().includes(searchTerm) ||
                    (entry.data.title && entry.data.title.toLowerCase().includes(searchTerm)) ||
                    (entry.data.personName && entry.data.personName.toLowerCase().includes(searchTerm)) ||
                    (entry.data.pantryNumber && entry.data.pantryNumber.toLowerCase().includes(searchTerm)) ||
                    (entry.data.items && entry.data.items.some(item => item.name.toLowerCase().includes(searchTerm)))
                );
            }

            return history;
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history? This action cannot be undone.')) {
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                showMessage('History cleared successfully', 'success');

                // Refresh history displays
                refreshHistoryDisplays();
            }
        }

        function refreshHistoryDisplays() {
            if (document.getElementById('historySection') && document.getElementById('historySection').style.display !== 'none') {
                showHistoryList();
            }
            if (document.getElementById('historyModal') && document.getElementById('historyModal').classList.contains('active')) {
                showHistoryForAll();
            }
        }

        function downloadHistory(format = 'detailed') {
            try {
                const history = getFilteredHistory();
                if (history.length === 0) {
                    showMessage('No history entries found to download', 'error');
                    return;
                }

                let content, filename, mimeType;

                if (format === 'csv') {
                    // CSV format
                    const csvHeaders = ['Date', 'Day', 'Action', 'Title', 'Person', 'Pantry', 'Total Items', 'Total Quantity', 'Session ID'];
                    const csvRows = history.map(entry => [
                        entry.humanDate,
                        entry.dayOfWeek,
                        entry.action,
                        entry.data.title || '',
                        entry.data.personName || '',
                        entry.data.pantryNumber || '',
                        entry.data.totalItems || 0,
                        entry.data.totalQuantity || 0,
                        entry.data.sessionId || ''
                    ]);

                    content = [csvHeaders, ...csvRows].map(row => 
                        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                    ).join('\n');
                    filename = `housekeeping_history_${new Date().toISOString().slice(0, 10)}.csv`;
                    mimeType = 'text/csv';
                } else {
                    // Detailed text format
                    content = generateDetailedHistoryReport(history);
                    filename = `housekeeping_history_detailed_${new Date().toISOString().slice(0, 10)}.txt`;
                    mimeType = 'text/plain';
                }

                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage(`History downloaded successfully (${format.toUpperCase()})`, 'success');
            } catch (error) {
                console.error('Error downloading history:', error);
                showMessage('Error downloading history', 'error');
            }
        }

        function generateDetailedHistoryReport(history) {
            let report = `OBLU SELECT Sangeli Housekeeping - History Report\n`;
            report += `Generated on: ${new Date().toLocaleString('en-US', { timeZone: 'Indian/Maldives' })}\n`;
            report += `Total Entries: ${history.length}\n`;
            report += `${'='.repeat(80)}\n\n`;

            // Summary statistics
            const stats = generateHistoryStats(history);
            report += `SUMMARY STATISTICS:\n`;
            report += `- Most Active User: ${stats.mostActiveUser} (${stats.mostActiveUserCount} actions)\n`;
            report += `- Most Common Action: ${stats.mostCommonAction} (${stats.mostCommonActionCount} times)\n`;
            report += `- Total Items Processed: ${stats.totalItemsProcessed}\n`;
            report += `- Total Quantity Processed: ${stats.totalQuantityProcessed}\n`;
            report += `- Date Range: ${stats.dateRange}\n`;
            report += `- Unique Users: ${stats.uniqueUsers}\n`;
            report += `- Unique Sessions: ${stats.uniqueSessions}\n\n`;
            report += `${'='.repeat(80)}\n\n`;

            // Detailed entries
            report += `DETAILED ENTRIES:\n\n`;
            history.forEach((entry, index) => {
                report += `Entry #${index + 1}\n`;
                report += `Date: ${entry.humanDate} (${entry.dayOfWeek})\n`;
                report += `Action: ${entry.action}\n`;
                report += `Title: ${entry.data.title || 'N/A'}\n`;
                report += `Person: ${entry.data.personName || 'N/A'}\n`;
                if (entry.data.pantryNumber) {
                    report += `Pantry: ${entry.data.pantryNumber}\n`;
                }
                report += `Total Items: ${entry.data.totalItems || 0}\n`;
                report += `Total Quantity: ${entry.data.totalQuantity || 0}\n`;
                report += `Session ID: ${entry.data.sessionId || 'N/A'}\n`;

                if (entry.data.items && entry.data.items.length > 0) {
                    report += `Items with quantities:\n`;
                    entry.data.items.forEach(item => {
                        report += `  - ${item.name}: ${item.quantity}\n`;
                    });
                }

                if (entry.data.filename) {
                    report += `Generated File: ${entry.data.filename}\n`;
                }

                report += `\n${'-'.repeat(40)}\n\n`;
            });

            return report;
        }

        function generateHistoryStats(history) {
            const userCounts = {};
            const actionCounts = {};
            let totalItems = 0;
            let totalQuantity = 0;
            const sessions = new Set();
            let earliestDate = null;
            let latestDate = null;

            history.forEach(entry => {
                // User statistics
                const user = entry.data.personName || 'Unknown';
                userCounts[user] = (userCounts[user] || 0) + 1;

                // Action statistics
                actionCounts[entry.action] = (actionCounts[entry.action] || 0) + 1;

                // Item and quantity statistics
                totalItems += entry.data.totalItems || 0;
                totalQuantity += entry.data.totalQuantity || 0;

                // Session tracking
                if (entry.data.sessionId) {
                    sessions.add(entry.data.sessionId);
                }

                // Date range
                const entryDate = new Date(entry.timestamp);
                if (!earliestDate || entryDate < earliestDate) earliestDate = entryDate;
                if (!latestDate || entryDate > latestDate) latestDate = entryDate;
            });

            const mostActiveUser = Object.keys(userCounts).reduce((a, b) => userCounts[a] > userCounts[b] ? a : b, 'N/A');
            const mostCommonAction = Object.keys(actionCounts).reduce((a, b) => actionCounts[a] > actionCounts[b] ? a : b, 'N/A');

            return {
                mostActiveUser,
                mostActiveUserCount: userCounts[mostActiveUser] || 0,
                mostCommonAction,
                mostCommonActionCount: actionCounts[mostCommonAction] || 0,
                totalItemsProcessed: totalItems,
                totalQuantityProcessed: totalQuantity,
                uniqueUsers: Object.keys(userCounts).length,
                uniqueSessions: sessions.size,
                dateRange: earliestDate && latestDate ? 
                    `${earliestDate.toLocaleDateString()} to ${latestDate.toLocaleDateString()}` : 'N/A'
            };
        }

        function copyHistoryToClipboard() {
            try {
                const history = getFilteredHistory();
                if (history.length === 0) {
                    showMessage('No history entries found to copy', 'error');
                    return;
                }

                const historyText = history.map(entry => {
                    let text = `ðŸ“… ${entry.humanDate} - ${entry.action}\n`;
                    text += `ðŸ‘¤ ${entry.data.personName || 'N/A'}`;
                    if (entry.data.title) text += ` | ðŸ“‹ ${entry.data.title}`;
                    if (entry.data.pantryNumber) text += ` | ðŸ  ${entry.data.pantryNumber}`;
                    if (entry.data.totalItems > 0) text += ` | ðŸ“¦ ${entry.data.totalItems} items (${entry.data.totalQuantity} total qty)`;
                    if (entry.data.items && entry.data.items.length > 0) {
                        text += `\n   Items: ${entry.data.items.map(i => `${i.name}(${i.quantity})`).join(', ')}`;
                    }
                    return text;
                }).join('\n\n');

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(historyText).then(() => {
                        showMessage('History copied to clipboard', 'success');
                    }).catch(() => fallbackCopyTextToClipboard(historyText));
                } else {
                    fallbackCopyTextToClipboard(historyText);
                }
            } catch (error) {
                console.error('Error copying history:', error);
                showMessage('Error copying history', 'error');
            }
        }

        function deleteHistoryEntry(entryId) {
            if (confirm('Delete this history entry?')) {
                try {
                    const history = getHistoryFromStorage();
                    const filteredHistory = history.filter(entry => entry.id !== entryId);
                    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(filteredHistory));
                    showMessage('History entry deleted', 'success');
                    refreshHistoryDisplays();
                } catch (error) {
                    console.error('Error deleting history entry:', error);
                    showMessage('Error deleting history entry', 'error');
                }
            }
        }

        function bulkDeleteHistory() {
            const selectedEntries = Array.from(document.querySelectorAll('.history-checkbox:checked')).map(cb => cb.value);
            if (selectedEntries.length === 0) {
                showMessage('No entries selected for deletion', 'error');
                return;
            }

            if (confirm(`Delete ${selectedEntries.length} selected history entries?`)) {
                try {
                    const history = getHistoryFromStorage();
                    const filteredHistory = history.filter(entry => !selectedEntries.includes(entry.id));
                    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(filteredHistory));
                    showMessage(`${selectedEntries.length} history entries deleted`, 'success');
                    refreshHistoryDisplays();
                } catch (error) {
                    console.error('Error bulk deleting history:', error);
                    showMessage('Error deleting history entries', 'error');
                }
            }
        }

        function showHistoryStats() {
            const history = getHistoryFromStorage();
            const stats = generateHistoryStats(history);

            const statsHtml = `
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">ðŸ“Š History Statistics</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                        <div><strong>Total Entries:</strong> ${history.length}</div>
                        <div><strong>Most Active User:</strong> ${stats.mostActiveUser} (${stats.mostActiveUserCount})</div>
                        <div><strong>Most Common Action:</strong> ${stats.mostCommonAction} (${stats.mostCommonActionCount})</div>
                        <div><strong>Total Items Processed:</strong> ${stats.totalItemsProcessed}</div>
                        <div><strong>Total Quantity:</strong> ${stats.totalQuantityProcessed}</div>
                        <div><strong>Unique Users:</strong> ${stats.uniqueUsers}</div>
                        <div><strong>Unique Sessions:</strong> ${stats.uniqueSessions}</div>
                        <div style="grid-column: 1 / -1;"><strong>Date Range:</strong> ${stats.dateRange}</div>
                    </div>
                </div>
            `;

            return statsHtml;
        }

        function showHistoryList() {
            const history = getFilteredHistory();
            const historySection = document.getElementById('historySection');

            if (!historySection) {
                const adminMenu = document.getElementById('adminMenu');
                const historyHTML = `
                    <div id="historySection" style="display: none;">
                        <h2>ðŸ“‹ Advanced History Management</h2>
                        ${createHistoryFiltersHTML()}
                        ${showHistoryStats()}
                        <div style="margin: 10px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="downloadHistory('detailed')" style="flex: 1; min-width: 100px; font-size: 11px;">ðŸ“¥ Download Detailed</button>
                            <button onclick="downloadHistory('csv')" style="flex: 1; min-width: 100px; font-size: 11px;">ðŸ“Š Download CSV</button>
                            <button onclick="copyHistoryToClipboard()" style="flex: 1; min-width: 100px; font-size: 11px;">ðŸ“‹ Copy Filtered</button>
                            <button onclick="bulkDeleteHistory()" style="flex: 1; min-width: 100px; font-size: 11px; background: #e74c3c;">ðŸ—‘ï¸ Delete Selected</button>
                            <button onclick="clearHistory()" style="flex: 1; min-width: 100px; font-size: 11px; background: #c0392b;">ðŸ—‘ï¸ Clear All</button>
                            <button onclick="showAdminMenu()" style="flex: 1; min-width: 100px; font-size: 11px;">â† Back</button>
                        </div>
                        <div id="historyList" style="max-height: 400px; overflow-y: auto; border: 1px solid #444; border-radius: 6px; background: var(--bg-tertiary); padding: 10px;"></div>
                    </div>
                `;
                adminMenu.insertAdjacentHTML('beforeend', historyHTML);
            } else {
                // Update existing section
                document.getElementById('historySection').innerHTML = `
                    <h2>ðŸ“‹ Advanced History Management</h2>
                    ${createHistoryFiltersHTML()}
                    ${showHistoryStats()}
                    <div style="margin: 10px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="downloadHistory('detailed')" style="flex: 1; min-width: 100px; font-size: 11px;">ðŸ“¥ Download Detailed</button>
                        <button onclick="downloadHistory('csv')" style="flex: 1; min-width: 100px; font-size: 11px;">ðŸ“Š Download CSV</button>
                        <button onclick="copyHistoryToClipboard()" style="flex: 1; min-width: 100px; font-size: 11px;">ðŸ“‹ Copy Filtered</button>
                        <button onclick="bulkDeleteHistory()" style="flex: 1; min-width: 100px; font-size: 11px; background: #e74c3c;">ðŸ—‘ï¸ Delete Selected</button>
                        <button onclick="clearHistory()" style="flex: 1; min-width: 100px; font-size: 11px; background: #c0392b;">ðŸ—‘ï¸ Clear All</button>
                        <button onclick="showAdminMenu()" style="flex: 1; min-width: 100px; font-size: 11px;">â† Back</button>
                    </div>
                    <div id="historyList" style="max-height: 400px; overflow-y: auto; border: 1px solid #444; border-radius: 6px; background: var(--bg-tertiary); padding: 10px;"></div>
                `;
            }

            document.getElementById('historySection').style.display = 'block';
            renderHistoryList(history);
        }

        function createHistoryFiltersHTML() {
            const history = getHistoryFromStorage();
            const uniquePersons = [...new Set(history.map(h => h.data.personName).filter(Boolean))];
            const uniqueActions = [...new Set(history.map(h => h.action))];

            return `
                <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 8px;">
                        <select onchange="updateHistoryFilter('action', this.value)" style="padding: 4px; font-size: 11px;">
                            <option value="all">All Actions</option>
                            ${uniqueActions.map(action => `<option value="${action}" ${historyFilters.action === action ? 'selected' : ''}>${action}</option>`).join('')}
                        </select>
                        <select onchange="updateHistoryFilter('dateRange', this.value)" style="padding: 4px; font-size: 11px;">
                            <option value="all" ${historyFilters.dateRange === 'all' ? 'selected' : ''}>All Time</option>
                            <option value="today" ${historyFilters.dateRange === 'today' ? 'selected' : ''}>Today</option>
                            <option value="week" ${historyFilters.dateRange === 'week' ? 'selected' : ''}>This Week</option>
                            <option value="month" ${historyFilters.dateRange === 'month' ? 'selected' : ''}>This Month</option>
                        </select>
                        <select onchange="updateHistoryFilter('person', this.value)" style="padding: 4px; font-size: 11px;">
                            <option value="all">All Persons</option>
                            ${uniquePersons.map(person => `<option value="${person}" ${historyFilters.person === person ? 'selected' : ''}>${person}</option>`).join('')}
                        </select>
                    </div>
                    <input type="text" placeholder="Search in history..." value="${historyFilters.searchTerm}" 
                           onkeyup="updateHistoryFilter('searchTerm', this.value)" 
                           style="width: 100%; padding: 6px; font-size: 11px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid #444;">
                    <div style="margin-top: 8px; font-size: 10px; color: #888;">
                        Showing ${getFilteredHistory().length} of ${getHistoryFromStorage().length} entries
                    </div>
                </div>
            `;
        }

        function updateHistoryFilter(filterType, value) {
            historyFilters[filterType] = value;
            renderHistoryList(getFilteredHistory());

            // Update the stats display
            const statsContainer = document.querySelector('#historySection .grid');
            if (statsContainer) {
                statsContainer.innerHTML = showHistoryStats();
            }
        }

        function renderHistoryList(history) {
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                historyList.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No history entries found with current filters</p>';
                return;
            }

            historyList.innerHTML = `
                <div style="margin-bottom: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">
                    <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" onchange="toggleAllHistoryCheckboxes(this.checked)" style="margin: 0;"> 
                        Select All (${history.length} entries)
                    </label>
                </div>
                ${history.map(entry => `
                    <div style="border-bottom: 1px solid #555; padding: 12px 0; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" class="history-checkbox" value="${entry.id}" style="margin: 0;">
                                <strong style="color: var(--primary-color); font-size: 12px;">${entry.action}</strong>
                                ${entry.data.totalItems > 0 ? `<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px;">${entry.data.totalItems} items</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="viewHistoryEntryDetails('${entry.id}')" 
                                        style="background: #2196F3; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">ðŸ‘ï¸</button>
                                <button onclick="deleteHistoryEntry('${entry.id}')" 
                                        style="background: #e74c3c; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">Ã—</button>
                            </div>
                        </div>
                        <div style="font-size: 10px; color: #888; margin-bottom: 5px;">
                            ðŸ“… ${entry.humanDate} (${entry.dayOfWeek})
                        </div>
                        <div style="font-size: 11px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 5px;">
                            <div><strong>Title:</strong> ${entry.data.title || 'N/A'}</div>
                            <div><strong>Person:</strong> ${entry.data.personName || 'N/A'}</div>
                            ${entry.data.pantryNumber ? `<div><strong>Pantry:</strong> ${entry.data.pantryNumber}</div>` : ''}
                            ${entry.data.totalQuantity > 0 ? `<div><strong>Total Qty:</strong> ${entry.data.totalQuantity}</div>` : ''}
                        </div>
                        ${entry.data.filename ? `<div style="font-size: 10px; color: #4CAF50; margin-top: 3px;">ðŸ“„ ${entry.data.filename}</div>` : ''}
                    </div>
                `).join('')}
            `;
        }

        function toggleAllHistoryCheckboxes(checked) {
            document.querySelectorAll('.history-checkbox').forEach(cb => cb.checked = checked);
        }

        function viewHistoryEntryDetails(entryId) {
            const history = getHistoryFromStorage();
            const entry = history.find(h => h.id === entryId);
            if (!entry) return;

            const modal = document.createElement('div');
            modal.className = 'password-modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--primary-color);">ðŸ“‹ History Entry Details</h2>
                        <button onclick="this.closest('.password-modal').remove()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">âœ•</button>
                    </div>
                    <div style="font-size: 12px; line-height: 1.6;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div><strong>Action:</strong> ${entry.action}</div>
                            <div><strong>Date:</strong> ${entry.humanDate}</div>
                            <div><strong>Day:</strong> ${entry.dayOfWeek}</div>
                            <div><strong>Session ID:</strong> ${entry.data.sessionId || 'N/A'}</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                            <div><strong>Title:</strong> ${entry.data.title || 'N/A'}</div>
                            <div><strong>Person:</strong> ${entry.data.personName || 'N/A'}</div>
                            ${entry.data.pantryNumber ? `<div><strong>Pantry:</strong> ${entry.data.pantryNumber}</div>` : ''}
                            ${entry.data.filename ? `<div><strong>Generated File:</strong> ${entry.data.filename}</div>` : ''}
                        </div>
                        ${entry.data.items && entry.data.items.length > 0 ? `
                            <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 6px;">
                                <strong>Items (${entry.data.items.length} total, ${entry.data.totalQuantity} quantity):</strong>
                                <div style="max-height: 200px; overflow-y: auto; margin-top: 8px;">
                                    ${entry.data.items.map(item => `
                                        <div style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #555;">
                                            <span style="flex: 1;">${item.name}</span>
                                            <span style="font-weight: bold; color: var(--primary-color);">${item.quantity}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showHistoryForAll() {
            let historyModal = document.getElementById('historyModal');

            if (!historyModal) {
                historyModal = document.createElement('div');
                historyModal.id = 'historyModal';
                historyModal.className = 'password-modal';
                document.body.appendChild(historyModal);
            }

            historyModal.innerHTML = `
                <div class="modal-content" style="width: 95%; max-width: 800px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--primary-color);">ðŸ“‹ Activity History</h2>
                        <button onclick="closeHistoryModal()" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">âœ•</button>
                    </div>
                    ${createHistoryFiltersHTML()}
                    ${showHistoryStats()}
                    <div style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="downloadHistory('detailed')" style="flex: 1; min-width: 100px; padding: 8px; font-size: 11px;">ðŸ“¥ Download Detailed</button>
                        <button onclick="downloadHistory('csv')" style="flex: 1; min-width: 100px; padding: 8px; font-size: 11px;">ðŸ“Š Download CSV</button>
                        <button onclick="copyHistoryToClipboard()" style="flex: 1; min-width: 100px; padding: 8px; font-size: 11px;">ðŸ“‹ Copy Filtered</button>
                        <button onclick="clearHistory()" style="flex: 1; min-width: 100px; padding: 8px; font-size: 11px; background: #e74c3c;">ðŸ—‘ï¸ Clear All</button>
                    </div>
                    <div id="publicHistoryList" style="flex: 1; overflow-y: auto; border: 1px solid #444; border-radius: 6px; background: var(--bg-tertiary); padding: 10px;"></div>
                </div>
            `;

            historyModal.classList.add('active');
            renderPublicHistoryList(getFilteredHistory());
        }

        function renderPublicHistoryList(history) {
            const historyList = document.getElementById('publicHistoryList');

            if (history.length === 0) {
                historyList.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No history entries found with current filters</p>';
                return;
            }

            historyList.innerHTML = history.map(entry => `
                <div style="border-bottom: 1px solid #555; padding: 12px 0; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: var(--primary-color); font-size: 12px;">${entry.action}</strong>
                            ${entry.data.totalItems > 0 ? `<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px;">${entry.data.totalItems} items</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="viewHistoryEntryDetails('${entry.id}')" 
                                    style="background: #2196F3; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">ðŸ‘ï¸</button>
                            <button onclick="deleteHistoryEntry('${entry.id}')" 
                                    style="background: #e74c3c; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">Ã—</button>
                        </div>
                    </div>
                    <div style="font-size: 10px; color: #888; margin-bottom: 5px;">
                        ðŸ“… ${entry.humanDate} (${entry.dayOfWeek})
                    </div>
                    <div style="font-size: 11px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 5px;">
                        <div><strong>Title:</strong> ${entry.data.title || 'N/A'}</div>
                        <div><strong>Person:</strong> ${entry.data.personName || 'N/A'}</div>
                        ${entry.data.pantryNumber ? `<div><strong>Pantry:</strong> ${entry.data.pantryNumber}</div>` : ''}
                        ${entry.data.totalQuantity > 0 ? `<div><strong>Total Qty:</strong> ${entry.data.totalQuantity}</div>` : ''}
                    </div>
                    ${entry.data.filename ? `<div style="font-size: 10px; color: #4CAF50; margin-top: 3px;">ðŸ“„ ${entry.data.filename}</div>` : ''}
                </div>
            `).join('');
        }

        function closeHistoryModal() {
            const historyModal = document.getElementById('historyModal');
            if (historyModal) {
                historyModal.classList.remove('active');
            }
        }

        // --- VALIDATION FUNCTIONS ---
        function validateRequiredFields(action = 'action') {
            const personName = document.getElementById('personName').value.trim();
            const title = document.getElementById('pdfTitle').value.trim();
            const pantryNum = document.getElementById('pantryNumber').value.trim();

            // Person name is always required
            if (!personName) {
                showMessage(`Please enter the "Filled by" name before performing this ${action}. This field is required for all operations.`, 'error');
                document.getElementById('personName').focus();
                document.getElementById('personName').style.borderColor = '#e74c3c';
                setTimeout(() => {
                    document.getElementById('personName').style.borderColor = '';
                }, 3000);
                return false;
            }

            // Check if pantry number is required but missing
            if ((title.includes('Pantry') || title.includes('pantry')) && !pantryNum) {
                showMessage(`Please enter the pantry number for pantry-related ${action}s. This field is required when working with pantry inventories.`, 'error');
                document.getElementById('pantryNumber').focus();
                document.getElementById('pantryNumber').style.borderColor = '#e74c3c';
                setTimeout(() => {
                    document.getElementById('pantryNumber').style.borderColor = '';
                }, 3000);
                return false;
            }

            return true;
        }

        // --- EXPORT FUNCTIONS ---
        function exportPDF() {
            if (!validateRequiredFields('PDF export')) {
                return;
            }

            const title = document.getElementById('pdfTitle').value.trim() || 'Housekeeping List';
            const personName = document.getElementById('personName').value.trim();
            const pantryNum = document.getElementById('pantryNumber').value.trim();

            // Check if pantry number is required but missing
            if ((title.includes('Pantry') || title.includes('pantry')) && !pantryNum) {
                showMessage('Please enter the pantry number for pantry-related requests.', 'error');
                document.getElementById('pantryNumber').focus();
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            const date = new Date().toLocaleString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', timeZone: 'Indian/Maldives'
            });

            // Compact header styling
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.setTextColor(40);
            doc.text('OBLU SELECT Sangeli Housekeeping', doc.internal.pageSize.getWidth() / 2, 12, { align: 'center' });

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(title, doc.internal.pageSize.getWidth() / 2, 18, { align: 'center' });

            let startY = 24;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);

            if (pantryNum) {
                doc.text(`Pantry Location: ${pantryNum}`, 12, startY);
                startY += 4;
            }
            doc.text(`Filled By: ${personName}`, 12, startY);
            doc.text(`Date: ${date}`, doc.internal.pageSize.getWidth() - 12, startY, { align: 'right' });

            const tableData = items.map(item => [item.fullName || item.name, item.quantity]);

            // Optimized single-page table configuration
            const tableConfig = {
                theme: 'grid',
                headStyles: { 
                    fillColor: '#4CAF50', /* Green */
                    textColor: '#FFFFFF', 
                    fontStyle: 'bold', 
                    fontSize: 9, 
                    cellPadding: { top: 2, right: 3, bottom: 2, left: 3 },
                    halign: 'center'
                },
                bodyStyles: { 
                    fontSize: 7, 
                    cellPadding: { top: 1.2, right: 3, bottom: 1.2, left: 3 },
                    textColor: 40,
                    lineColor: '#CCCCCC',
                    lineWidth: 0.1
                },
                alternateRowStyles: {
                    fillColor: '#F8F9FA'
                },
                columnStyles: { 
                    0: { 
                        cellWidth: 150, 
                        halign: 'left',
                        fontSize: 6.8
                    }, 
                    1: { 
                        cellWidth: 30, 
                        halign: 'center',
                        fontStyle: 'bold',
                        fontSize: 8
                    } 
                },
                startY: startY + 5,
                margin: { left: 12, right: 12 },
                pageBreak: 'avoid',
                showFoot: false,
                tableWidth: 'auto',
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap',
                    minCellHeight: 2.8,
                    valign: 'middle'
                }
            };

            doc.autoTable({
                head: [["Item Description", "Qty"]],
                body: tableData,
                ...tableConfig
            });

            // Compact footer
            const finalY = doc.lastAutoTable.finalY || startY + 50;
            if (finalY < 280) {
                doc.setFontSize(6);
                doc.setTextColor(120);
                doc.text('Generated by OBLU SELECT Sangeli Housekeeping System', doc.internal.pageSize.getWidth() / 2, 290, { align: 'center' });
            }

            const safeTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const safePersonName = personName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `${safePersonName}_${safeTitle}_${dateStr}.pdf`;

            doc.save(filename);

            // Save to history
            const itemsWithQuantity = items.filter(item => item.quantity > 0);
            saveToHistory('PDF Export', {
                title: title,
                personName: personName,
                pantryNumber: pantryNum,
                filename: filename,
                items: itemsWithQuantity.map(item => ({
                    name: item.fullName || item.name,
                    quantity: item.quantity
                }))
            });

            showMessage('PDF downloaded successfully!', 'success');
        }

        function exportXLSX() {
            if (!validateRequiredFields('XLSX export')) {
                return;
            }

            const title = document.getElementById('pdfTitle').value.trim() || 'Pantry Request';
            const personName = document.getElementById('personName').value.trim();
            const pantryNum = document.getElementById('pantryNumber').value.trim();

            if (title.startsWith('Trolley')) {
                const date = new Date().toLocaleString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', timeZone: 'Indian/Maldives'
                });

                const header_data = [
                    ["Title:", title],
                    ["Name:", personName],
                    ["Date:", date],
                    [] // Blank spacer row
                ];
                const item_headers = [["Item Name", "Quantity"]];
                // Convert quantity to a string to ensure '0' is exported correctly.
                // Always use fullName for export, fallback to name if fullName doesn't exist
                const item_data = items.map(i => [i.fullName || i.name, i.quantity.toString()]);
                const ws_data = [...header_data, ...item_headers, ...item_data];

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                // Adjust column widths for better readability - bring quantity closer to item names
                ws['!cols'] = [{ wch: 45 }, { wch: 12 }];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Trolley Inventory");
                const safeTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const safePersonName = personName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const dateStr = new Date().toISOString().slice(0, 10);
                const filename = `${safePersonName}_${safeTitle}_${dateStr}.xlsx`;

                XLSX.writeFile(wb, filename);

                // Save to history
                const itemsWithQuantity = items.filter(item => item.quantity > 0);
                saveToHistory('XLSX Export', {
                    title: title,
                    personName: personName,
                    filename: filename,
                    items: itemsWithQuantity.map(item => ({
                        name: item.fullName || item.name,
                        quantity: item.quantity
                    }))
                });

                showMessage('XLSX downloaded successfully!', 'success');
                return;
            }

            // Pantry Export Logic - validation already done above

            const pantryNumDisplay = pantryNum || 'N/A';
            const personNameDisplay = personName || 'N/A';
            const wb = XLSX.utils.book_new();
            const ws = {};
            const addStyledCell = (cellRef, value, style = {}) => { ws[cellRef] = { v: value, t: 's', s: style }; };
            const getStock = (itemName) => { const item = items.find(i => i.name === itemName); return item ? item.quantity : 0; };
            let currentRow = 0;
            currentRow++;
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 1 }), title, { font: { bold: true, sz: 18 }, alignment: { horizontal: 'center', vertical: 'center' } });
            ws['!merges'] = [{ s: { r: currentRow, c: 1 }, e: { r: currentRow, c: 3 } }];
            currentRow += 2;
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 0 }), 'Guest Supplies & Amenities', { font: { bold: true, sz: 14 }, alignment: { horizontal: 'left' } });
            ws['!merges'].push({ s: { r: currentRow, c: 0 }, e: { r: currentRow, c: 3 } });
            currentRow++;
            currentRow++;
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 0 }), 'Pantry Number:', { font: { bold: true }, alignment: { horizontal: 'left' } });
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 1 }), pantryNumDisplay, { alignment: { horizontal: 'left' } });
            ws['!merges'].push({ s: { r: currentRow, c: 1 }, e: { r: currentRow, c: 3 } });
            currentRow++;
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 0 }), 'Filled By:', { font: { bold: true }, alignment: { horizontal: 'left' } });
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 1 }), personNameDisplay, { alignment: { horizontal: 'left' } });
            ws['!merges'].push({ s: { r: currentRow, c: 1 }, e: { r: currentRow, c: 3 } });
            currentRow += 2;
            const headerStyle = { font: { bold: true }, fill: { fgColor: { rgb: "D3D3D3" } }, border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } } };
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 0 }), 'S.No', headerStyle);
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 1 }), 'Items', headerStyle);
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 2 }), 'Unit', headerStyle);
            addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 3 }), 'Stock', headerStyle);
            const dataSections = [
                [[1, 'Shampoo Noir (3ltr, Gellon)', 'Gellon', getStock('Shampoo Noir (3ltr, Gellon)')], [2, 'Conditioner Noir(3ltr, Gellon)', 'Gellon', getStock('Conditioner Noir(3ltr, Gellon)')], [3, 'Shower Gel Noir (3ltr, Gellon)', 'Gellon', getStock('Shower Gel Noir (3ltr, Gellon)')], [4, 'Hand & Body Lotion Noir (3ltr, Gellon)', 'Gellon', getStock('Hand & Body Lotion Noir (3ltr, Gellon)')], [5, 'Cleansing Hand Noir (3ltr, Gellon)', 'Gellon', getStock('Cleansing Hand Noir (3ltr, Gellon)')], [6, 'Soap Wrapped 30G Noir', 'Nos', getStock('Soap Wrapped 30G Noir')], [7, 'Shampoo Noir (300ml)', 'Nos', getStock('Shampoo Noir (300ml)')], [8, 'Conditioner Noir(300ml)', 'Nos', getStock('Conditioner Noir(300ml)')], [9, 'Shower Gel Noir(300ml)', 'Nos', getStock('Shower Gel Noir(300ml)')], [10, 'Hand & Body Lotion Noir(300ml)', 'Nos', getStock('Hand & Body Lotion Noir(300ml)')], [11, 'Cleansing Hand Noir (300ml)', 'Nos', getStock('Cleansing Hand Noir (300ml)')], [12, 'Kimnica White Gold Standard Toothbrush Pack', 'Nos', getStock('Kimnica White Gold Standard Toothbrush Pack')], [13, 'Kimnica Razor Pack(on request)', 'Nos', getStock('Kimnica Razor Pack(on request)')], [14, 'Stich kit(on request)', 'Nos', getStock('Stich kit(on request)')], [15, 'Wooden Comb kit(on request)', 'Nos', getStock('Wooden Comb kit(on request)')], [16, 'Natural Lordah kit(on request)', 'Nos', getStock('Natural Lordah kit(on request)')], [17, 'Sunscreen lotion(on request)', 'Nos', getStock('Sunscreen lotion(on request)')], [18, 'Insect repellent lotion(on request)', 'Nos', getStock('Insect repellent lotion(on request)')], [19, 'Lip Balm', 'Nos', getStock('Lip Balm')], [20, 'Bathroom Slippers Kit Size 10', 'Nos', getStock('Bathroom Slippers Kit Size 10')], [21, 'Bathroom Slippers Kit Size 11', 'Nos', getStock('Bathroom Slippers Kit Size 11')], [22, 'Scott Facial Tissue Cube Box 90 Sheets(48)', 'Nos', getStock('Scott Facial Tissue Cube Box 90 Sheets(48)')], [23, 'Kleenex bathroom Tissue 2ply - 50Opulls x 20rolls x 4bags', 'Nos', getStock('Kleenex bathroom Tissue 2ply - 50Opulls x 20rolls x 4bags')], [24, 'Milk Portion Rainbow 14g', 'Nos', getStock('Milk Portion Rainbow 14g')], [25, 'Coffee Espresso Cremoso 50 Cap - Vergnano', 'Nos', getStock('Coffee Espresso Cremoso 50 Cap - Vergnano')], [26, 'Coffee Espresso Decaffeinated 50 Cap - Vergnano', 'Nos', getStock('Coffee Espresso Decaffeinated 50 Cap - Vergnano')], [27, 'Coffee Espresso Intenso 50 Cap - Vergnano', 'Nos', getStock('Coffee Espresso Intenso 50 Cap - Vergnano')], [28, 'Coffee Segafredo Le Origini Brasil Capsules 6gmx50', 'Nos', getStock('Coffee Segafredo Le Origini Brasil Capsules 6gmx50')], [29, 'Coffee Segafredo Espresso Capsules 6gmx150', 'Nos', getStock('Coffee Segafredo Espresso Capsules 6gmx150')], [30, 'Coffee Segafredo Decaffeinated Capsules 6gmx50', 'Nos', getStock('Coffee Segafredo Decaffeinated Capsules 6gmx50')], [31, 'Sugar Brown Sachets - 5G', 'Nos', getStock('Sugar Brown Sachets - 5G')], [32, 'Sugar White Sachets - 5G', 'Nos', getStock('Sugar White Sachets - 5G')], [33, 'Sugar Equal Sugar 10g', 'Nos', getStock('Sugar Equal Sugar 10g')], [34, 'Ravena Tea English Breakfast Bag', 'Nos', getStock('Ravena Tea English Breakfast Bag')], [35, 'Ravena Tea Green tea', 'Nos', getStock('Ravena Tea Green tea')], [36, 'Ravena Charnomile (Herbal Tea)', 'Nos', getStock('Ravena Charnomile (Herbal Tea)')], [37, 'Ravena Tea permit', 'Nos', getStock('Ravena Tea permit')], [38, 'Mosquito Spray - 640ml / 400ml(only beach villas)', 'Nos', getStock('Mosquito Spray - 640ml / 400ml(only beach villas)')], [39, 'outdoor slipper - 10" - Orange colour', 'Nos', getStock('outdoor slipper - 10" - Orange colour')], [40, 'outdoor slipper - 11" - Blue colour', 'Nos', getStock('outdoor slipper - 11" - Blue colour')], [41, 'Canvas Beach Bag 57 X 12X 40cm', 'Nos', getStock('Canvas Beach Bag 57 X 12X 40cm')], [42, 'Laundry Bag with the Logo/without Logo', 'Nos', getStock('Laundry Bag with the Logo/without Logo')], [43, 'Bubble Bath', 'Nos', getStock('Bubble Bath')], [44, 'Brasso', 'Nos', getStock('Brasso')], [45, 'R1', 'Nos', getStock('R1')],[46, 'R2', 'Nos', getStock('R2')],[47, 'R3', 'Nos', getStock('R3')], [48, 'R4', 'Nos', getStock('R4')],[49, 'R5', 'Nos', getStock('R5')],[50, 'R6', 'Nos', getStock('R6')], [51, 'R7', 'Nos', getStock('R7')],[52, 'Dustin Bag', 'Nos', getStock('Dustin Bag')]]
            ];
            // Dynamically add new items to the XLSX export
            const existingItems = dataSections[0].map(row => row[1]);
            items.forEach((item, index) => {
                if (!existingItems.includes(item.name)) {
                    dataSections[0].push([dataSections[0].length + 1, item.name, 'Nos', item.quantity]);
                }
            });
            dataSections.forEach(section => section.forEach(rowData => {
                currentRow++;
                const baseStyle = { border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } } };
                addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 0 }), rowData[0], baseStyle);
                addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 1 }), rowData[1], baseStyle);
                addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 2 }), rowData[2], baseStyle);
                addStyledCell(XLSX.utils.encode_cell({ r: currentRow, c: 3 }), rowData[3], baseStyle);
            }));
            ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: currentRow, c: 3 } });
            ws['!cols'] = [{ wch: 5 }, { wch: 50 }, { wch: 10 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Inventory');
            const safeTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const safePersonName = personNameDisplay.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `${safePersonName}_${safeTitle}_${dateStr}.xlsx`;

            XLSX.writeFile(wb, filename);

            // Save to history
            const itemsWithQuantity = items.filter(item => item.quantity > 0);
            saveToHistory('XLSX Export', {
                title: title,
                personName: personNameDisplay,
                pantryNumber: pantryNum,
                filename: filename,
                items: itemsWithQuantity.map(item => ({
                    name: item.name,
                    quantity: item.quantity
                }))
            });

            showMessage('XLSX downloaded successfully!', 'success');
        }

        // Import button is now always visible, no secret functionality needed
    </script>
</body>
</html>